<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    input, button { padding: 8px; font-size: 16px; margin: 4px 0; width: 100%; box-sizing: border-box; }
    .note { border-bottom: 1px solid #ccc; padding: 10px 0; }
    .note input { width: 60%; }
    .note button { margin-left: 10px; }
    #playerContainer { width: 100%; height: 360px; margin-bottom: 20px; background: #000; position: relative; }
    #playerContainer video,
    #playerContainer iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  </style>
</head>
<body>
  <h2>üé¨ –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</h2>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–ª–µ–µ—Ä–∞ (video –∏–ª–∏ iframe) -->
  <div id="playerContainer"></div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏ -->
  <label>‚è± –í—Ä–µ–º—è (—Å–µ–∫ –∏–ª–∏ MM:SS):</label>
  <input id="timeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 90 –∏–ª–∏ 1:30">
  <label>URL –≤–∏–¥–µ–æ (YouTube –∏–ª–∏ MP4):</label>
  <input id="srcInput" placeholder="https://.../video.mp4 –∏–ª–∏ YouTube-—Å—Å—ã–ª–∫–∞">
  <label>üìù –¢–µ–º–∞ –º–µ—Ç–∫–∏:</label>
  <input id="titleInput" placeholder="–¢–µ–º–∞...">
  <button onclick="saveNote()">üìå –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫—É</button>

  <hr>

  <input id="search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderNotes(this.value)">
  <div id="notesList"></div>

  <script>
    let notes = JSON.parse(localStorage.getItem('vid_notes') || '[]');

    // –í—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–µ–µ—Ä –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: video –∏–ª–∏ iframe
    function loadPlayer(src, sec) {
      const cont = document.getElementById('playerContainer');
      cont.innerHTML = ''; // –æ—á–∏—Å—Ç–∏—Ç—å
      // –¥–µ—Ç–µ–∫—Ç YouTube
      let ytId = null;
      if (/youtu\\.be\\//.test(src)) {
        ytId = src.split('youtu.be/')[1].split(/[?&]/)[0];
      } else if (/youtube\\.com\\//.test(src)) {
        const m = src.match(/[?&]v=([^&]+)/);
        if (m) ytId = m[1];
      }

      if (ytId) {
        // —Å–æ–∑–¥–∞—ë–º iframe embed
        const ifr = document.createElement('iframe');
        ifr.src = 'https://www.youtube.com/embed/' + ytId + '?start=' + sec + '&autoplay=0';
        ifr.frameBorder = '0';
        ifr.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
        cont.appendChild(ifr);
      } else {
        // —á–∏—Å—Ç—ã–π —Ñ–∞–π–ª ‚Äî video
        const vid = document.createElement('video');
        vid.controls = true;
        vid.src = src;
        vid.addEventListener('loadedmetadata', () => vid.currentTime = sec );
        cont.appendChild(vid);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ
    const params = new URLSearchParams(location.search);
    if (params.has('src') && params.has('time')) {
      const rawSrc = decodeURIComponent(params.get('src'));
      const sec    = parseFloat(params.get('time')) || 0;
      const title  = params.has('title')
                     ? decodeURIComponent(params.get('title'))
                     : `–ú–µ—Ç–∫–∞ ${sec}s`;

      loadPlayer(rawSrc, sec);

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∞—Ä—Ö–∏–≤ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
      if (!notes.some(n=>n.src===rawSrc&&n.seconds===sec&&n.title===title)) {
        notes.push({ title, seconds: sec, src: rawSrc, created: new Date().toLocaleString() });
        localStorage.setItem('vid_notes', JSON.stringify(notes));
      }

      history.replaceState(null, '', location.pathname);
    }

    function parseTime(input) {
      if (!input) return NaN;
      if (input.includes(':')) {
        const parts = input.split(':').map(Number).reverse();
        return parts.reduce((sum,v,i)=> sum + v*Math.pow(60,i),0);
      }
      return parseInt(input,10);
    }

    function saveNote() {
      const sec   = parseTime(document.getElementById('timeInput').value.trim());
      const src   = document.getElementById('srcInput').value.trim();
      const title = document.getElementById('titleInput').value.trim();
      if (!src || isNaN(sec) || !title) {
        return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≤—Ä–µ–º—è, URL –∏ —Ç–µ–º—É.');
      }
      notes.push({ title, seconds: sec, src, created: new Date().toLocaleString() });
      localStorage.setItem('vid_notes', JSON.stringify(notes));
      document.getElementById('timeInput').value = '';
      document.getElementById('srcInput').value = '';
      document.getElementById('titleInput').value = '';
      renderNotes();
    }

    function formatTime(s) {
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
      return [h,m,ss].map(x=>String(x).padStart(2,'0')).join(':');
    }

    function renderNotes(filter='') {
      const list = document.getElementById('notesList');
      const q = filter.toLowerCase();
      const filtered = notes.filter(n=>n.title.toLowerCase().includes(q));
      list.innerHTML = '';
      if (!filtered.length) {
        list.innerHTML = '<i>–ú–µ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</i>'; return;
      }
      filtered.forEach((n,i) => {
        const div = document.createElement('div'); div.className='note';
        const inp = document.createElement('input'); inp.value=n.title;
        inp.onchange =()=>{ n.title=inp.value; localStorage.setItem('vid_notes',JSON.stringify(notes)); };
        const a = document.createElement('a');
        a.href = '?src='+encodeURIComponent(n.src)
               +'&time='+n.seconds
               +'&title='+encodeURIComponent(n.title);
        a.target='_blank'; a.textContent='–ü–µ—Ä–µ–π—Ç–∏';
        const btn = document.createElement('button'); btn.textContent='üóë';
        btn.onclick =()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å?')){ notes.splice(i,1); localStorage.setItem('vid_notes',JSON.stringify(notes)); renderNotes(filter);} };
        const info = document.createElement('small');
        info.textContent = `üïì ${n.created} | ‚è± ${formatTime(n.seconds)}`;
        div.append(inp, a, btn, document.createElement('br'), info);
        list.append(div);
      });
    }

    renderNotes();
  </script>
</body>
</html>
