<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</title>
  <style>
    body { font-family:sans-serif; padding:20px; max-width:800px; margin:auto }
    input, button { width:100%; padding:10px; margin:6px 0; font-size:16px }
    .note { border-bottom:1px solid #ccc; padding:10px 0 }
    .note input { width:60%; display:inline-block }
    .note a, .note button { margin-left:10px }
    #playerContainer { margin:20px 0 }
    small { color:#555 }
  </style>
</head>
<body>

<h2>üé¨ –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫</h2>

<input id="videoURL" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ (YouTube –∏–ª–∏ .mp4 –∏–ª–∏ VK)" />
<button id="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>

<div id="playerContainer"></div>

<input id="titleInput" placeholder="–¢–µ–º–∞ –º–µ—Ç–∫–∏" />
<button id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫—É</button>

<hr>

<input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ‚Ä¶" />
<div id="notesList"></div>

<script>
  let notes = JSON.parse(localStorage.getItem("vid_notes")||"[]");

  // –ü—Ä–∏ –∑–∞—Ö–æ–¥–µ –∏–∑ –±—É–∫–º–∞—Ä–∫–ª–µ—Ç–∞
  (function(){
    const p = new URLSearchParams(location.search),
          src   = p.get('src'),
          title = p.get('title'),
          time  = parseFloat(p.get('time'));
    if(src && title && !isNaN(time)){
      notes.push({ src: decodeURIComponent(src), title: decodeURIComponent(title), seconds: time, created: new Date().toLocaleString() });
      localStorage.setItem("vid_notes", JSON.stringify(notes));
      history.replaceState(null,'',location.pathname);
    }
  })();

  const container = document.getElementById('playerContainer'),
        urlInput  = document.getElementById('videoURL'),
        titleEl   = document.getElementById('titleInput'),
        btnLoad   = document.getElementById('btnLoad'),
        btnSave   = document.getElementById('btnSave'),
        search    = document.getElementById('search'),
        list      = document.getElementById('notesList');

  function play(src, t=0){
    container.innerHTML = '';
    // YouTube
    let m = src.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([\w-]{11})/);
    if(m){
      let id = m[1];
      container.innerHTML = `<iframe width="100%" height="480" src="https://www.youtube.com/embed/${id}?start=${t}&autoplay=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
      return;
    }
    // else MP4 or VK direct
    let vid = document.createElement('video');
    vid.controls = true;
    vid.src = src;
    vid.width = container.clientWidth;
    container.appendChild(vid);
    vid.addEventListener('loadedmetadata', ()=>{
      vid.currentTime = t;
      vid.play();
    });
  }

  btnLoad.onclick = ()=> {
    let s = urlInput.value.trim();
    if(!s) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
    play(s, 0);
  };

  btnSave.onclick = ()=> {
    // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º src –∏ –≤—Ä–µ–º—è
    let sec = 0, src = '', v = container.querySelector('video'), i = container.querySelector('iframe');
    if(location.host.includes('vk.com')) {
      // –¥–ª—è VK –≤—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
      src = location.href.replace(/#.*$/,'');
      // –µ—Å–ª–∏ –µ—Å—Ç—å video —ç–ª–µ–º–µ–Ω—Ç, —á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è, –∏–Ω–∞—á–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
      if(v) sec = Math.round(v.currentTime);
      else {
        let inp = prompt('–í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö','0');
        if(!inp) return;
        sec = parseInt(inp,10);
        if(isNaN(sec)) return alert('–ù–µ–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è');
      }
    } else if(v) {
      sec = Math.round(v.currentTime);
      src = v.currentSrc;
    } else if(i) {
      let inp = prompt('–í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö','0');
      if(!inp) return;
      sec = parseInt(inp,10);
      if(isNaN(sec)) return alert('–ù–µ–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è');
      src = i.src;
    } else {
      return alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ');
    }

    let t = titleEl.value.trim();
    if(!t) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É');
    notes.push({ title: t, seconds: sec, src: src, created: new Date().toLocaleString() });
    localStorage.setItem("vid_notes", JSON.stringify(notes));
    titleEl.value = '';
    render();
  };

  search.oninput = render;

  function fmt(s){
    let h = String(Math.floor(s/3600)).padStart(2,'0'),
        m = String(Math.floor((s%3600)/60)).padStart(2,'0'),
        sec= String(Math.floor(s%60)).padStart(2,'0');
    return `${h}:${m}:${sec}`;
  }

  function render(){
    let q = search.value.toLowerCase();
    list.innerHTML = notes
      .map((n,i)=>({n,i}))
      .filter(x=>x.n.title.toLowerCase().includes(q))
      .map(({n,i})=>{
        // —Å—Ç—Ä–æ–∏–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
        let link;
        if(n.src.includes('vk.com/video')) {
          link = n.src; // —Å—Ç—Ä–∞–Ω–∏—Ü–∞ VK
        } else {
          let m = n.src.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([\w-]{11})/);
          if(m) link = `https://www.youtube.com/watch?v=${m[1]}&t=${n.seconds}s`;
          else link = n.src;
        }
        return `<div class="note">
          <input value="${n.title}" data-i="${i}" class="edit">
          <a href="${link}" target="_blank" rel="noopener">–ü–µ—Ä–µ–π—Ç–∏</a>
          <button data-i="${i}" class="del">üóë –£–¥–∞–ª–∏—Ç—å</button><br>
          <small>${n.created} | ${fmt(n.seconds)}</small>
        </div>`;
      }).join('') || '<i>–ú–µ—Ç–æ–∫ –Ω–µ—Ç</i>';
  }

  // –¥–µ–ª–µ–≥–∏—Ä—É–µ–º
  list.onclick = e => {
    if(e.target.classList.contains('del')) {
      let i = +e.target.dataset.i;
      if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
        notes.splice(i,1);
        localStorage.setItem("vid_notes", JSON.stringify(notes));
        render();
      }
    }
    if(e.target.classList.contains('edit')) {
      let i = +e.target.dataset.i;
      notes[i].title = e.target.value;
      localStorage.setItem("vid_notes", JSON.stringify(notes));
    }
  };

  render();
</script>
</body>
</html>
