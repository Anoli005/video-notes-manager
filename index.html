<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    input, button { padding: 8px; font-size: 16px; margin: 4px 0; width: 100%; }
    .note { border-bottom: 1px solid #ccc; padding: 10px 0; }
    .note input { width: 60%; }
    .note button { margin-left: 10px; }
  </style>
</head>
<body>
  <h2>üé¨ –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</h2>
  <video id="player" controls style="width:100%;margin-bottom:20px;"></video>

  <label>‚è± –í—Ä–µ–º—è (—Å–µ–∫—É–Ω–¥—ã –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç 1:30):</label>
  <input id="timeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 90 –∏–ª–∏ 1:30">

  <label>üìù –¢–µ–º–∞ –º–µ—Ç–∫–∏:</label>
  <input id="titleInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä—ã">

  <button onclick="saveNote()">üìå –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫—É</button>

  <hr>

  <input id="search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderNotes(this.value)">
  <div id="notesList"></div>

  <script>
    const timeEl = document.getElementById("timeInput");
    const titleEl = document.getElementById("titleInput");
    let notes = JSON.parse(localStorage.getItem("vid_notes") || "[]");

    const params = new URLSearchParams(location.search);
    if (params.has('src') && params.has('time')) {
      const rawSrc  = decodeURIComponent(params.get('src'));
      const sec     = parseFloat(params.get('time')) || 0;
      const title   = params.get('title') ? decodeURIComponent(params.get('title')) : "";

      const player = document.getElementById("player");
      player.src = rawSrc;
      player.addEventListener("loadedmetadata", () => {
        player.currentTime = sec;
      });

      notes.push({
        title: title || `–ú–µ—Ç–∫–∞ ${formatTime(sec)}`,
        seconds: sec,
        src: rawSrc,
        created: new Date().toLocaleString()
      });
      localStorage.setItem("vid_notes", JSON.stringify(notes));
      history.replaceState(null, "", location.pathname);
    }

    function parseTime(t) {
      if (!t) return 0;
      const parts = t.split(":").map(Number).reverse();
      return parts.reduce((sum, v, i) => sum + v * Math.pow(60, i), 0);
    }

    function saveNote() {
      const sec = parseTime(timeEl.value.trim());
      const title = titleEl.value.trim();
      if (!title) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É.");
      const src = prompt("URL –≤–∏–¥–µ–æ:", location.href);
      notes.push({ title, seconds: sec, src, created: new Date().toLocaleString() });
      localStorage.setItem("vid_notes", JSON.stringify(notes));
      timeEl.value = ""; titleEl.value = "";
      renderNotes();
    }

    function formatTime(s) {
      const h = String(Math.floor(s/3600)).padStart(2,'0'),
            m = String(Math.floor((s%3600)/60)).padStart(2,'0'),
            ss = String(s%60).padStart(2,'0');
      return `${h}:${m}:${ss}`;
    }

    function renderNotes(filter="") {
      const list = document.getElementById("notesList");
      const q = filter.toLowerCase();
      const displayed = notes.filter(n=>n.title.toLowerCase().includes(q));
      list.innerHTML = displayed.map((n,i)=>{
        const url = `?src=${encodeURIComponent(n.src)}&time=${n.seconds}&title=${encodeURIComponent(n.title)}`;
        return `<div class="note">
           <input value="${n.title}" onchange="edit(${i}, this.value)">
           <a href="${url}">–ü–µ—Ä–µ–π—Ç–∏</a>
           <button onclick="del(${i})">üóë</button><br>
           <small>üïì ${n.created} | ‚è± ${formatTime(n.seconds)}</small>
         </div>`
      }).join("") || "<i>–ú–µ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</i>";
    }

    function edit(i,v){
      notes[i].title = v;
      localStorage.setItem("vid_notes", JSON.stringify(notes));
    }

    function del(i){
      if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
        notes.splice(i,1);
        localStorage.setItem("vid_notes", JSON.stringify(notes));
        renderNotes();
      }
    }

    renderNotes();
  </script>
</body>
</html>
