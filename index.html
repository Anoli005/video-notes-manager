<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    input, button { padding: 8px; font-size: 16px; margin: 4px 0; width: 100%; box-sizing: border-box; }
    .note { border-bottom: 1px solid #ccc; padding: 10px 0; }
    .note input { width: 60%; }
    .note button { margin-left: 10px; }
    video { width: 100%; margin-bottom: 20px; }
  </style>
</head>
<body>
  <h2>üé¨ –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</h2>

  <!-- –ü–ª–µ–µ—Ä –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ –º–µ—Ç–∫–µ -->
  <video id="player" controls></video>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏ -->
  <label>‚è± –í—Ä–µ–º—è (—Å–µ–∫ –∏–ª–∏ MM:SS):</label>
  <input id="timeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 90 –∏–ª–∏ 1:30">
  <label>URL –≤–∏–¥–µ–æ (–±–µ–∑ #t):</label>
  <input id="srcInput" placeholder="https://.../video.mp4 –∏–ª–∏ YouTube-—Å—Å—ã–ª–∫–∞">
  <label>üìù –¢–µ–º–∞ –º–µ—Ç–∫–∏:</label>
  <input id="titleInput" placeholder="–¢–µ–º–∞...">
  <button onclick="saveNote()">üìå –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫—É</button>

  <hr>

  <input id="search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderNotes(this.value)">
  <div id="notesList"></div>

  <script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –∏–∑ localStorage
    let notes = JSON.parse(localStorage.getItem('vid_notes') || '[]');

    // –ü—Ä–∏ –∑–∞—Ö–æ–¥–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ?src=...&time=...&title=...
    const params = new URLSearchParams(location.search);
    if (params.has('src') && params.has('time')) {
      const rawSrc = decodeURIComponent(params.get('src'));
      const sec    = parseFloat(params.get('time')) || 0;
      const title  = params.has('title')
                     ? decodeURIComponent(params.get('title'))
                     : `–ú–µ—Ç–∫–∞ ${formatTime(sec)}`;

      // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –ø–ª–µ–µ—Ä –∏ –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º
      const player = document.getElementById('player');
      player.src = rawSrc;
      player.addEventListener('loadedmetadata', () => {
        player.currentTime = sec;
      });

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∞—Ä—Ö–∏–≤, –µ—Å–ª–∏ –Ω–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–∞
      if (!notes.some(n => n.src === rawSrc && n.seconds === sec && n.title === title)) {
        notes.push({
          title: title,
          seconds: sec,
          src: rawSrc,
          created: new Date().toLocaleString()
        });
        localStorage.setItem('vid_notes', JSON.stringify(notes));
      }

      // –û—á–∏—â–∞–µ–º GET-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
      history.replaceState(null, '', location.pathname);
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç "MM:SS" –∏–ª–∏ "SS" –≤ —Å–µ–∫—É–Ω–¥—ã
    function parseTime(input) {
      if (!input) return NaN;
      if (input.includes(':')) {
        const parts = input.split(':').map(Number).reverse();
        return parts.reduce((sum, v, i) => sum + v * Math.pow(60, i), 0);
      }
      return parseInt(input, 10);
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç–∫—É –∏–∑ —Ñ–æ—Ä–º—ã –≤—Ä—É—á–Ω—É—é
    function saveNote() {
      const sec   = parseTime(document.getElementById('timeInput').value.trim());
      const src   = document.getElementById('srcInput').value.trim();
      const title = document.getElementById('titleInput').value.trim();
      if (!src || isNaN(sec) || !title) {
        return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≤—Ä–µ–º—è, URL –∏ —Ç–µ–º—É.');
      }
      notes.push({
        title: title,
        seconds: sec,
        src: src,
        created: new Date().toLocaleString()
      });
      localStorage.setItem('vid_notes', JSON.stringify(notes));
      // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
      document.getElementById('timeInput').value = '';
      document.getElementById('srcInput').value = '';
      document.getElementById('titleInput').value = '';
      renderNotes();
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å–µ–∫—É–Ω–¥—ã –≤ HH:MM:SS
    function formatTime(s) {
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const ss = s % 60;
      return [h, m, ss].map(x => String(x).padStart(2,'0')).join(':');
    }

    // –†–µ–Ω–¥–µ—Ä–∏—Ç —Å–ø–∏—Å–æ–∫ –º–µ—Ç–æ–∫
    function renderNotes(filter = '') {
      const list = document.getElementById('notesList');
      const q = filter.toLowerCase();
      const filtered = notes.filter(n => n.title.toLowerCase().includes(q));
      list.innerHTML = '';
      if (!filtered.length) {
        list.innerHTML = '<i>–ú–µ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</i>';
        return;
      }
      filtered.forEach((n, i) => {
        const div = document.createElement('div');
        div.className = 'note';

        const inp = document.createElement('input');
        inp.value = n.title;
        inp.onchange = () => {
          n.title = inp.value;
          localStorage.setItem('vid_notes', JSON.stringify(notes));
        };

        const a = document.createElement('a');
        a.href = '?src=' + encodeURIComponent(n.src)
               + '&time=' + n.seconds
               + '&title=' + encodeURIComponent(n.title);
        a.target = '_blank';
        a.textContent = '–ü–µ—Ä–µ–π—Ç–∏';

        const btn = document.createElement('button');
        btn.textContent = 'üóë';
        btn.onclick = () => {
          if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
            notes.splice(i, 1);
            localStorage.setItem('vid_notes', JSON.stringify(notes));
            renderNotes(filter);
          }
        };

        const info = document.createElement('small');
        info.textContent = `üïì ${n.created} | ‚è± ${formatTime(n.seconds)}`;

        div.append(inp, a, btn, document.createElement('br'), info);
        list.append(div);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    renderNotes();
  </script>
</body>
</html>
