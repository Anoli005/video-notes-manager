<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üé¨ –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</title>
  <style>
    body { font-family: sans-serif; padding:20px; max-width:800px; margin:auto; background:#f9f9f9 }
    input, button { padding:10px; font-size:16px; margin:6px 0; width:100%; box-sizing:border-box }
    .note { border-bottom:1px solid #ccc; padding:10px 0 }
    .note input { width:60%; }
    .note .goto, .note .del { margin-left:10px; }
    #playerContainer { width:100%; margin:20px 0 }
    label { font-weight:bold }
    small { color:#555 }
  </style>
</head>
<body>

<h2>üé¨ –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</h2>

<input id="videoURL" placeholder="üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ (YouTube –∏–ª–∏ .mp4)" />
<button id="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>

<div id="playerContainer"></div>

<label>üìù –¢–µ–º–∞ –º–µ—Ç–∫–∏:</label>
<input id="titleInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä—ã" />
<button id="btnSave">üìå –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫—É</button>

<hr>

<input id="search" placeholder="üîç –ü–æ–∏—Å–∫ –º–µ—Ç–æ–∫" />
<div id="notesList"></div>

<script>
  let notes = JSON.parse(localStorage.getItem("vid_notes")||"[]");
  // –∞–≤—Ç–æ–∑–∞—Ö–≤–∞—Ç –∏–∑ URL (–±—É–∫–º–∞—Ä–∫–ª–µ—Ç)
  (function(){
    const p = new URLSearchParams(location.search),
          src   = p.get('src'),
          title = p.get('title'),
          time  = parseFloat(p.get('time'));
    if(src&&title&&!isNaN(time)){
      notes.push({ src:decodeURIComponent(src), title:decodeURIComponent(title), seconds:time, created:new Date().toLocaleString() });
      localStorage.setItem("vid_notes",JSON.stringify(notes));
      history.replaceState(null,'',location.pathname);
    }
  })();

  const container = document.getElementById('playerContainer'),
        urlInput  = document.getElementById('videoURL'),
        titleEl   = document.getElementById('titleInput'),
        btnLoad   = document.getElementById('btnLoad'),
        btnSave   = document.getElementById('btnSave'),
        search    = document.getElementById('search'),
        list      = document.getElementById('notesList');

  function playSrc(src, start=0){
    container.innerHTML='';
    const yt = src.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([\w-]{11})/);
    if(yt){
      const ifr=document.createElement('iframe');
      ifr.src=`https://www.youtube.com/embed/${yt[1]}?start=${start}&autoplay=1`;
      ifr.width='100%'; ifr.height='480';
      ifr.allow='accelerometer; autoplay; encrypted-media; picture-in-picture';
      ifr.allowFullscreen=true;
      container.appendChild(ifr);
    } else {
      const vid=document.createElement('video');
      vid.controls=true; vid.src=src; vid.width=container.clientWidth;
      container.appendChild(vid);
      vid.addEventListener('loadedmetadata',()=>{ vid.currentTime=start; vid.play(); });
    }
  }

  btnLoad.addEventListener('click',()=>{
    const s=urlInput.value.trim();
    if(!s) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
    playSrc(s,0);
  });

  btnSave.addEventListener('click',()=>{
    let sec=0, src='';
    const v=container.querySelector('video'),
          i=container.querySelector('iframe');
    if(v){
      sec=Math.round(v.currentTime); src=v.src;
    } else if(i){
      const inp=prompt('‚è± –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–æ—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—É—â–µ–µ –µ—Å–ª–∏ OK):','0');
      if(!inp) return; sec=parseInt(inp,10);
      if(isNaN(sec)) return alert('–ù–µ–≤–µ—Ä–Ω–æ–µ —á–∏—Å–ª–æ');
      src=i.src;
    } else return alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ');
    const t=titleEl.value.trim();
    if(!t) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É');
    notes.push({ title:t, seconds:sec, src, created:new Date().toLocaleString() });
    localStorage.setItem('vid_notes',JSON.stringify(notes));
    titleEl.value=''; renderNotes();
  });

  search.addEventListener('input',()=>renderNotes());

  function fmt(s){
    const h=String(Math.floor(s/3600)).padStart(2,'0'),
          m=String(Math.floor((s%3600)/60)).padStart(2,'0'),
          sec=String(Math.floor(s%60)).padStart(2,'0');
    return `${h}:${m}:${sec}`;
  }

  function renderNotes(){
    const q=search.value.toLowerCase();
    list.innerHTML = notes
      .map((n,i)=>({n,i}))
      .filter(o=>o.n.title.toLowerCase().includes(q))
      .map(({n,i})=>{
        // –í–ö-–≤–∏–¥–µ–æ: –ø—Ä–æ—Å—Ç–æ —Å—Å—ã–ª–∫–∞, –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–¥–∞—Ç—å –Ω–µ–ª—å–∑—è
        let link;
        if(/vk\.com\/video/.test(n.src)){
          link = n.src;
        } else {
          const yt=n.src.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([\w-]{11})/);
          link = yt
            ? `https://www.youtube.com/watch?v=${yt[1]}&t=${n.seconds}s`
            : n.src;
        }
        return `
          <div class="note">
            <input value="${n.title}" data-i="${i}" class="edit">
            <button class="goto" data-link="${link}">–ü–µ—Ä–µ–π—Ç–∏</button>
            <button class="del" data-i="${i}">üóë –£–¥–∞–ª–∏—Ç—å</button><br>
            <small>üïì ${n.created} | ‚è± ${fmt(n.seconds)}</small>
          </div>`;
      }).join('') || '<i>–ú–µ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</i>';
  }

  // –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤
  list.addEventListener('click',e=>{
    if(e.target.matches('button.goto')){
      window.open(e.target.dataset.link,'_blank');
    }
    if(e.target.matches('button.del')){
      const i=+e.target.dataset.i;
      if(confirm('–£–¥–∞–ª–∏—Ç—å?')){ notes.splice(i,1); localStorage.setItem('vid_notes',JSON.stringify(notes)); renderNotes(); }
    }
  });

  // —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
  list.addEventListener('change',e=>{
    if(e.target.matches('input.edit')){
      const i=+e.target.dataset.i;
      notes[i].title=e.target.value;
      localStorage.setItem('vid_notes',JSON.stringify(notes));
    }
  });

  renderNotes();
</script>

</body>
</html>
