<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üé¨ –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</title>
  <style>
    body { font-family: sans-serif; padding:20px; max-width:800px; margin:auto; background:#f9f9f9 }
    input, button { padding:10px; font-size:16px; margin:6px 0; width:100%; box-sizing:border-box }
    .note { border-bottom:1px solid #ccc; padding:10px 0 }
    .note input { width:60%; }
    .note button { margin-left:10px; }
    #playerContainer { width:100%; margin:20px 0 }
    label { font-weight:bold }
    small { color:#555 }
  </style>
</head>
<body>

<h2>üé¨ –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ—Ç–æ–∫ –∫ –≤–∏–¥–µ–æ</h2>

<input id="videoURL" placeholder="üîó –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (YouTube –∏–ª–∏ .mp4)" />
<button id="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>

<div id="playerContainer"></div>

<label for="titleInput">üìù –¢–µ–º–∞ –º–µ—Ç–∫–∏:</label>
<input id="titleInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä—ã" />
<button id="btnSave">üìå –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫—É –ø–æ —Ç–µ–∫—É—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏</button>

<hr>

<input id="search" placeholder="üîç –ü–æ–∏—Å–∫..." />
<div id="notesList"></div>

<script>
  let notes = JSON.parse(localStorage.getItem("vid_notes") || "[]");

  // –∞–≤—Ç–æ-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑ URL (–±—É–∫–º–∞—Ä–∫–ª–µ—Ç)
  ;(function(){
    const p = new URLSearchParams(location.search);
    const src   = p.get('src'),
          title = p.get('title'),
          time  = parseFloat(p.get('time'));
    if (src && title && !isNaN(time)) {
      notes.push({ src:decodeURIComponent(src), title:decodeURIComponent(title), seconds:time, created:new Date().toLocaleString() });
      localStorage.setItem("vid_notes", JSON.stringify(notes));
      history.replaceState(null,'',location.pathname);
    }
  })();

  const container = document.getElementById('playerContainer');
  const urlInput  = document.getElementById("videoURL");
  const titleEl   = document.getElementById("titleInput");
  const btnLoad   = document.getElementById("btnLoad");
  const btnSave   = document.getElementById("btnSave");
  const search    = document.getElementById("search");
  const list      = document.getElementById("notesList");

  function playSrc(src, startTime=0) {
    container.innerHTML = '';
    const yt = src.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([\w-]{11})/);
    if (yt) {
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${yt[1]}?start=${startTime}&autoplay=1`;
      iframe.width = '100%'; iframe.height = '480';
      iframe.allow = 'accelerometer; autoplay; encrypted-media; picture-in-picture';
      iframe.allowFullscreen = true;
      container.appendChild(iframe);
    } else {
      const video = document.createElement('video');
      video.controls = true;
      video.src = src;
      video.width = container.clientWidth;
      container.appendChild(video);
      video.addEventListener('loadedmetadata', () => {
        video.currentTime = startTime;
        video.play();
      });
    }
  }

  btnLoad.addEventListener('click', () => {
    const src = urlInput.value.trim();
    if (!src) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ.");
    playSrc(src, 0);
  });

  btnSave.addEventListener('click', () => {
    let sec=0, src='';
    const v = container.querySelector('video');
    const i = container.querySelector('iframe');
    if (v) {
      sec = Math.round(v.currentTime);
      src = v.src;
    } else if (i) {
      const input = prompt("‚è± –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö:", 0);
      if (!input) return;
      sec = parseInt(input,10);
      if (isNaN(sec)) return alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è");
      src = i.src;
    } else {
      return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ.");
    }
    const t = titleEl.value.trim();
    if (!t) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É.");
    notes.push({ title:t, seconds:sec, src, created:new Date().toLocaleString() });
    localStorage.setItem("vid_notes", JSON.stringify(notes));
    titleEl.value = '';
    renderNotes();
  });

  search.addEventListener('input', () => renderNotes(search.value));

  function formatTime(s) {
    const h = String(Math.floor(s/3600)).padStart(2,'0'),
          m = String(Math.floor((s%3600)/60)).padStart(2,'0'),
          sec = String(Math.floor(s%60)).padStart(2,'0');
    return `${h}:${m}:${sec}`;
  }

  function renderNotes() {
    const q = search.value.toLowerCase();
    list.innerHTML = notes
      .map((n,i) => ({n,i}))
      .filter(({n}) => n.title.toLowerCase().includes(q))
      .map(({n,i}) => {
        // –ø–æ–ª–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π –ª–∏–Ω–∫
        let link;
        const yt = n.src.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([\w-]{11})/);
        if (yt) {
          link = `https://www.youtube.com/watch?v=${yt[1]}&t=${n.seconds}s`;
        } else {
          link = n.src;
        }
        return `
          <div class="note">
            <input value="${n.title}" data-index="${i}" class="edit">
            <button class="goto" data-link="${link}">–ü–µ—Ä–µ–π—Ç–∏</button>
            <button class="del" data-index="${i}">üóë –£–¥–∞–ª–∏—Ç—å</button><br>
            <small>üïì ${n.created} | ‚è± ${formatTime(n.seconds)}</small>
          </div>
        `;
      })
      .join('') || "<i>–ú–µ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</i>";
  }

  // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –≤—Å–µ –∫–ª–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞
  list.addEventListener('click', e => {
    if (e.target.matches('button.goto')) {
      const url = e.target.dataset.link;
      window.open(url, '_blank');
    }
    if (e.target.matches('button.del')) {
      const idx = +e.target.dataset.index;
      if (confirm("–£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É?")) {
        notes.splice(idx,1);
        localStorage.setItem("vid_notes", JSON.stringify(notes));
        renderNotes();
      }
    }
  });

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –º–µ—Ç–∫–∏
  list.addEventListener('change', e => {
    if (e.target.matches('input.edit')) {
      const idx = +e.target.dataset.index;
      notes[idx].title = e.target.value;
      localStorage.setItem("vid_notes", JSON.stringify(notes));
    }
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  renderNotes();
</script>

</body>
</html>
